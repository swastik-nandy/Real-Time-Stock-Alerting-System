<!DOCTYPE html>
{% load static %}
<html>
<head>

    <title>Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>  <!-- jQuery for AJAX -->


    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>

    <script>
         function askNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                console.log('Notification permission:', permission);
                });
        }
    }

       askNotificationPermission();
    </script>

         
</head>


<body>

<h1>Welcome, {{ full_name }}!</h1>
<p style="font-size: 0.9em; color: gray;">@{{ username }}</p>
<p>Email: {{ email }}</p>

<form method="post" action="{% url 'logout' %}">
    {% csrf_token %}
    <button type="submit">Logout</button>
</form>

<hr>

<h2>Create New Stock Alert</h2>
<form method="post">
    {% csrf_token %}

    <label for="stock">Select Stock:</label><br>
    <select name="stock" id="stock" required>
        {% for stock in stocks %}
            <option value="{{ stock.id }}">{{ stock.symbol }} - {{ stock.company_name }}</option>
        {% endfor %}
    </select><br><br>

    <label for="target_price">Target Price:</label><br>
    <input type="number" step="0.01" name="target_price" required><br><br>

    <label for="condition">Condition:</label><br>
    <select name="condition" required>
        <option value="above">Above Target Price</option>
        <option value="below">Below Target Price</option>
    </select><br><br>

    <button type="submit">Create Alert</button>
</form>

<hr>

<h2>My Active Alerts</h2>
<table border="1" cellpadding="10">
    <thead>
        <tr>
            <th>Stock</th>
            <th>Target Price</th>
            <th>Condition</th>
            <th>Latest Price</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for alert in user_alerts %}
        <tr>
            <td>{{ alert.stock.symbol }}</td>
            <td>{{ alert.target_price }}</td>
            <td>{{ alert.condition|capfirst }}</td>
            <td>{{ alert.stock.latest_price }}</td> <!-- Live price updated -->
            <td>{% if alert.is_triggered %} Triggered {% else %} Active {% endif %}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No active alerts yet.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<hr>

<h2>Trending Stocks</h2>
<div id="trending-stock-table-container">
    {% include 'accounts/partials/trending_stocks_table.html' %}
</div>

<script>
setInterval(function() {
    $.ajax({
        url: "{% url 'refresh_trending_stocks' %}",
        success: function(data) {
            $('#trending-stock-table-container').html(data.html);
        }
    });
}, 5000);  // Every 5 seconds refresh
</script>

<script>
    const VAPID_PUBLIC_KEY = "{{ vapid_public_key|safe }}";
</script>


<script src="{% static 'accounts/js/notifier.js' %}"></script>

<script>
    setInterval(function() {
        $.ajax({
            url: "{% url 'check_alerts' %}",
            method: "GET",
            success: function(response) {
                response.alerts.forEach(function(alert) {
                    showNotification(alert.stock, alert.message);
                });
            }
        });
    }, 5000); // Check every 5 seconds
    </script>
<script>
    function urlBase64ToUint8Array(base64String) {
        const padding = "=".repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
        const rawData = atob(base64);
        return new Uint8Array([...rawData].map((char) => char.charCodeAt(0)));
    }

    document.addEventListener("DOMContentLoaded", () => {
        if ("serviceWorker" in navigator && "PushManager" in window) {
            navigator.serviceWorker.ready.then(registration => {
                registration.pushManager.getSubscription().then(existingSub => {
                    if (existingSub) {
                        console.log("[âœ”] Already subscribed");
                        return;
                    }

                    const vapidKey = VAPID_PUBLIC_KEY;
                    const convertedKey = urlBase64ToUint8Array(vapidKey);

                    registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedKey
                    }).then(subscription => {
                        console.log("[SUB] Subscribing user to push service...", subscription);

                        fetch("/save-subscription/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify(subscription)
                        }).then(() => {
                            console.log("[SUB] Subscription saved");
                        }).catch(err => console.error("[SUB] Failed to save:", err));
                    });
                });
            });
        }
    });
</script>

</body>
</html>